<#
.SYNOPSIS
    Checks your SMBv3 Compression setting as mitigation for CVE-2020-0796, also known as SMBGhost.
.DESCRIPTION
    This Powershell Script determines whether SMBv3 Compression is enabled or not. As mitigation on the CVE-2020-0796, the SMBv3 compression should be disabled. This script can disable SMBv3 for you automatically.
    Script is also checking if the CVE-2020-0976 is applicable to your Windows version and whether the Windows Update KB4551762 is installed or not.
.EXAMPLE
    PS C:\> .\CVE-2020-0796-Smbv3-checker.ps1
.NOTES
    Created by: T13nn3s
    Date: 11-03-2020
    Check my blog: https://binsec.nl
    Last update: 12-03-2020
#>

If (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {   
    $arguments = "& '" + $myinvocation.mycommand.definition + "'"
    Start-Process powershell -Verb runAs -ArgumentList $arguments
    Break
}
function CheckWindowsVersion {
    Write-Host "[*] Checking Windows Version..."
    $WindowsVersion = Get-ComputerInfo | Select-Object -ExpandProperty WindowsVersion
    Write-Host "Windows version $WindowsVersion found."
    if ($WindowsVersion -eq 1903) {
        Write-Host "CVE-2020-0976 is applicable to your Windows Version."
    }
    Elseif ($WindowsVersion -eq 1909) {
        Write-Host "CVE-2020-0976 is applicable to your Windows Version."
    }
    Else {
        Write-Host "CVE-2020-0976 is not applicable to your Windows Version." -ForegroundColor Green
        pause
        return
    }
}

function CheckIfUpdateIsInstalled {
    Write-Host "[*] Check if KB4551762 is installed..."

    $fix = Get-HotFix -Id KB4551762 -ErrorAction SilentlyContinue
    
    if($fix) {
        Write-Host "[+] *** Windows Update $($fix.HotFixID) is installed on $($fix.InstalledOn). You're not vulnerable ***"
        return
    } Else {
        Write-Host "[-] Windows Update $($kb) is not installed."
    }
}
function Get-Menu {
    param (
        [string]$title = "Mitigation for CVE-2020-0796 (CoronaBlue)"
    )
    Write-Host "================ $title ================"

    Write-Host "1: Press '1' for check your current SMBv3 Compression setting" 
    Write-Host "2: Press '2' to disable SMBv3 Compression <= This is the mitigation for CVE-2020-0796"
    Write-Host "3: Press '3' Enable SMBv3 Compression"
    Write-Host "Q: Press 'Q' to quit."

} # End function Get-Menu
function CheckRegSmbv3Compression {
    param (
        [string]$reg = "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters"
    )

    $check = Get-ItemProperty -Path $reg -Name "DisableCompression" -ErrorAction SilentlyContinue

    if ($check -eq $null) {
        Write-Host "SMBv3 Compression is not configued. SMBv3 Compression is set to enabled by default."
        Write-Host "You're vulnerable" -f yellow
    }
    Elseif ($check.DisableCompression -eq 0) {
        Write-Host "SMBv3 Compression is set to enabled."
    }
    Elseif ($check.DisableCompression -eq 1) {
        Write-Host "SMBv3 Compression is disabled."
    }
} # End function CheckRegSmbv3Compression 

function SetkRegSmbv3Compression {
    param (
        [string]$reg = "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters",
        [string]$value
    )
    try {
        Set-ItemProperty -Path $reg DisableCompression -Type DWORD -Value $value -Force
    }
    Catch {
        $err = $_.Exception.Message
        Write-Error $err
    }
    CheckRegSmbv3Compression
} #End function SetRegSmbv3Compression

CheckWindowsVersion
CheckIfUpdateIsInstalled

Do {
    Get-Menu
    $input = Read-Host "Please make a selection"
    switch ($input) {
        '1' {
            Write-Host 'You chose option #1'
            CheckRegSmbv3Compression
        } '2' {
            Write-Host 'You chose option #2'
            SetkRegSmbv3Compression -value 1
        } '3' {
            Write-Host 'You chose option #3'
            SetkRegSmbv3Compression -value 0
        } 'Q' {
            return
        }
    }
    pause
}
until ($input -eq 'q')
